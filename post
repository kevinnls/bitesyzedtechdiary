#!/bin/sh

set -e

[ -n "${DEBUG}" ] && set -x

convert_date_string(){ if { date '+%F' --date="${1}" 2>/dev/null;};then return 0;else >&2 echo 'invalid date string provided';return 1;fi; }

while [ ${#} -gt 0 ]; do
	case "${1}" in
		--edit|-e)
			action=edit
			;;
		--name|-n)
			action=name
			;;
		--publish|-p)
			action=publish
			;;
		--unpublish|-u)
			action=unpublish
			;;
		*)
			_date=$(convert_date_string "${1}")
			;;
	esac
	shift 1
done

_date="${_date:-$(convert_date_string now)}"
_postpattern="${_date}-*.md"

for _dir in '_drafts/' '_posts/'; do
	if [ -z "${post_name}" ]; then
		post_name=$(find "${_dir}" -name "${_postpattern}" -printf %P)
		post_dir="${post_name:+${_dir}}"
	fi
done

if [ -z "${post_name}" ]; then
	>&2 echo creating post for ${_date}
	>&2 read -p "NAME/SLUG REQUIRED: " slug

	post_name="${_postpattern%%\**}${slug// /-}${_postpattern##*\*}"
	### hey. i know you forgot.
	# - %%\** - delete everything after \*
	# - ##*\* - delete everything before \*

	cp -u _drafts/_post-template.md "${post_dir}${post_name}"
fi

case ${action:-name} in
	name)
		printf '%s\n' "${post_dir}${post_name}"
		;;
	edit)
		"${EDITOR:-vi}" "${post_dir}${post_name}"
		;;
	publish)
		if [ "${post_dir}" != '_posts/' ]; then
			mv "_drafts/${post_name}" "_posts/${post_name}"
		else
			echo "${post_name} is already in _posts"
		fi
		;;
	unpublish)
		if [ "${post_dir}" != "_drafts/" ]; then
			mv "_posts/${post_name}" "_drafts/${post_name}"
		else
			echo "${post_name} has not been published yet"
		fi
		;;
	*)
		>&2 echo <<- EOM
		CONGRATS!

		you managed to trigger an exception
		that shouldn't have been possible

		i hate you.
		EOM
		;;
esac
